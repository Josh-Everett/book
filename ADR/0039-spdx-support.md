# 0. Record architecture decisions

Date: 2024-09-24

## Status

Proposed

## Context

SPDX SBOM format enables additional features not available in cyclondedx like multiple purl attributes per component. SPDX is also a widely adopted standard for software bill of materials.
This ADR describes how to enable use of SPDX SBOM format in Konflux.

## Decision


### SBOM lifecycle in build pipeline

At the start SBOMs are generated by cachi2 and syft. At later phase of the build pipeline, SBOMs from base images are extracted and merged toghether with SBOMs generated for the currently build container. When switching to spdx, newly built container image can be used as base image another container image. Therefore any tooling/task which works with sboms has to be able to work with both formats.
Due to that fact, all tools and tasks should implement sbomType attribute which will be used to determine sbom format expected on the input and produced on the output. It will also allow tools to be tested for spdx before whole ppile is switched to spdx.

### CycloneDX -> SPDX conversion

CycloneDX (1.4) is structured document in json format with following structure (not full specification)

- Document Root
    - Metadata
        - Tools
            - List<Tool>
                - vendor
                - name
    - Components
        - List<Component>
            - name
            - version
            - purl
            - properties
            - List<Property>
                - name
                - value
    - formulations
        - List<Component>

SPDX (2.3) is structured document in json format with following structure(not full specification):
- Document Root
    - name
    - SPDXID
    - creationInfo
        - Creators
            - List<String>
    - components
        - List<Component>
            - SPDXID
            - name
            - versionInfo
            - externalRefs
                - List<ExternalRef>
                    - referenceCategory
                    - referenceType
                    - referenceLocator
            - annotations
                - List<Annotation>
                    - annotationDate
                    - annotationType
                    - annotator
                    - Comment
            - relationships
                - List<Relationship>
                    - spdxElementId
                    - relationshipType
                    - relatedSpdxElement

#### 1:1 conversions
Following CycloneDX to SPDX attributes are converted as 1:1 as they represent the same thing.

| SPDX Attribute        | CycloneDX Attribute |
|-----------------------|---------------------|
| components            | packages            |
| component.name        | package.name        |
| component.versionInfo | package.version     |
|-----------------------|---------------------|


#### Component.purl
CycloneDX (version 1.4) supports only a single purl attribute per component. SPDX doesn’t have a direct attribute, but instead every package includes an externalRefs array which describes all external references for the package. There are defined reference categories and types. For PURL, category PACKAGE-MANAGER and type purl is used. The purl itself will be stored as referenceLocator

|------------------------------|---------------------------------------------------------------|
| component.purl = <PURL>      | package.externalRefs = [{referenceCategory:”PACKAGE-MANAGER”, |
|                              |                          referenceType:purl,                  |
|                              |                         referenceLocator: <PURL>              |
|                              |                          }]                                   |
|------------------------------|---------------------------------------------------------------|


#### Component.properties
CycloneDX components properties describe mapping of string:string properties for given component. SPDX component doesn’t have anything similar to cyclonedx properties. SPDX Package annotations are the only attribute where custom data can be stored and the only “customizable” field there is comment which is simple string. Due to that fact, cycloneDX property in format of {“name”: <string>, “value”: <string>} is encoded into json string. There can be also annotations produced by other tools. Therefore to be able to tell annotation comment is json encoded, annotator should ends with string “:jsonencoded”

|---------------------------------|------------------------------------------------------------|
| package.properties = [          | component.annotations = [                                  |
|   {“name”: …, “value”: …}       |   {..., annotator: <tool>”:jsonencoded”                    |
| ]                               | ]                                                          |
|---------------------------------|------------------------------------------------------------|


#### Formulations
CycloneDX formulations describe how the container was manufactured. In SPDX, Relationship elements can be used for the same purpose. All elements in SPDX have SPDXID attribute which is an element identifier unique in the whole SBOM document. Relationship element describes relation between two elements using their SPDXID and relationship type. Relationship type BUILD_TOOL_OF can be used to express the relationship of packages which were used to build the container.

|---------------------------------|------------------------------------------------------------|
| Formulations.components = [{}]  | Relationships = [{                                         |
|                                 |  spdxElementId = <A-PACKAGE-ID>                            |
|                                 |  relationshipType=BUILD_TOOL_OF                            |
|                                 |  relatedSpdxElement=<ROOT-DOCUMENT-ID>                     |
|                                 | }]                                                         |
|---------------------------------|------------------------------------------------------------|


#### Metadata.tools
For CycloneDX tools sub attributes, we are mostly interested in, are vendor and name elements. Information about creation of SPDX document can be stored into creationInfo. CreationInfo.creators element is basically a list of strings. There’s vague specification about how it should be structured in the standard. Strings should be formatted in the following way: “<Attribute>: <Value>”. For example vendor should be stored as “Vendor: <vendor>”

|------------------------------------------------|--------------------------------------------------|
| Metadata.tools = [{“vendor”: “X”, “name”: “Y”] |CreationInfo.creators = [“Vendor: X”, “Tool: Y”]  |
|------------------------------------------------|--------------------------------------------------|


#### Merging SPDX
##### Packages
Packages of two SPDX documents can be merged together as a concatenation of two lists. In cycloneDX component elements can have only a single purl attribute, therefore component elements representing packages with the same name and version but with different purl have to be stored as multiple elements. CycloneDX package elements can bear multiple purls. Therefore multiple cycloneDX components can be squashed together into single SPDX package element with purls concatenated into a single list. Following rules are applied to packages merging process:
Packages with the same package name and versionInfo are squashed into single package element
Package with the same package name and versionInfo set to None (or empty) is squashed with package with the same name and non-empty versionInfo
NOTE: packages cannot be merged together based on SPDXID attribute as there’s no specification in spdx standard how SPDXID should be calculated. Individual tools can calculate it differently while still passing condition to make it unique across the whole document.
##### Relationships
SPDX relationships represent graph/tree structure of relations of elements in the document. Root element is SPDX document itself. Individual packages are in relationship CONTAINS with the root document. In the case of packages which were used to build the container. Packages are in relationship BUILD_TOOL_OF with the root document.
NOTE: Packages can be wrapped in a “virtual package”. This package can have empty name and version and on attributes, or name can be set to directory or container name which was set as source for generating SBOM document. This element has insignificant information value and can be omitted.
Relations of two documents needs to be merged together into single graph in a way which keeps the graph structure of the original graph of the main document (into which other document will be merged to). Once packages are merged together, relationships of the second document can be cleared off relations which refer to packages not included in the merged package list. SpdxElementId and relatedSpdxElement point to root document id of the second document should be replaced with root document id of the main document. If there’s “virtual package” in the second document, ids in relationships referring to it should be replaced with “virtual package” of the main document or main document id directly (if there’s no “virtual package”)


## Consequences
All tooling used in pipeline needs to support SPDX SBOM format


## References
CycloneDX specification https://cyclonedx.org/specification/overview/o
SPDX specification https://spdx.github.io/spdx-spec/v2.3/
SPDX json schema https://github.com/spdx/spdx-spec/blob/development/v2.3/schemas/spdx-schema.json#L724
